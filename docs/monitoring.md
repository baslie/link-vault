# Мониторинг и наблюдаемость Link Vault

Документ описывает подход к сбору клиентских метрик, логированию ошибок и контролю ключевых показателей производительности.

## Поток данных

1. **Клиентские события** фиксируются в `MonitoringProvider`:
   - глобальные ошибки (`window.onerror`, `unhandledrejection`);
   - производительность поиска (длительность запроса `/api/links`);
   - web vitals (LCP, FID, CLS и другие метрики Next.js).
2. События сериализуются в унифицированном формате (`monitoringEventSchema`) и отправляются на `/api/monitoring/log` c использованием `navigator.sendBeacon` (fallback — `fetch`).
3. API-роут сохраняет записи в таблицу `public.monitoring_events` (jsonb-поле `payload` + тип события). Таблица индексируется по `created_at` для быстрых выборок.
4. Аналитика (Яндекс.Метрика, Google Analytics) продолжает собирать агрегированные данные по действиям пользователя.

## Хранимые события

| Тип                  | Поле `details`                                      | Назначение                             |
| -------------------- | --------------------------------------------------- | -------------------------------------- |
| `web_vital`          | `id`, `name`, `value`, `rating`, `label`            | Оценка LCP/CLS/INP и других Web Vitals |
| `client_error`       | `message`, `stack`, `source`, `line`, `column`      | Диагностика фронтенд-ошибок            |
| `search_performance` | `durationMs`, `status` (`success`/`error`), `query` | Контроль требования «поиск < 500мс»    |

Каждое событие дополняется контекстом (`userAgent`, `url`) для отладки.

## Метрики и пороговые значения

- **Загрузка страницы**: отслеживается по LCP; допустимое значение `< 2000 мс`.
- **Поиск**: длительность запросов `/api/links`; событие `search_performance` добавляет предупреждение при `status = "error"` или `durationMs > 500` (анализируется при выгрузке из БД).
- **Ошибки**: количество записей `client_error` в Supabase показывает стабильность клиента.

## Переменные окружения

| Переменная                  | Значение                                                  |
| --------------------------- | --------------------------------------------------------- |
| `YANDEX_METRIKA_ID`         | Идентификатор счётчика Яндекс.Метрики                     |
| `GA_TRACKING_ID`            | Идентификатор GA4/Universal Analytics                     |
| `SUPABASE_SERVICE_ROLE_KEY` | Используется API `/api/monitoring/log` для записи событий |

## Проверка и эксплуатация

1. **Unit-тесты**: `pnpm test --filter perf` проверяет схему и клиент отправки событий.
2. **Ручная проверка**:
   - открыть приложение локально, выполнить поиск, сменить тему, специально бросить ошибку в консоли;
   - убедиться, что в таблице `monitoring_events` появляются новые записи (`select * from monitoring_events order by created_at desc limit 20;`).
3. **Аналитика**: настроить цели/ивенты в Метрике/GA на основе событий `link_created`, `import_completed`, `export_generated`, `theme_changed`.

Документ следует обновлять при добавлении новых типов событий или интеграций с внешними сервисами мониторинга.
